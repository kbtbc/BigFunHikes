<!DOCTYPE html>
<html>
<head>
  <title>Map Test</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; }
    #map { height: 600px; width: 100%; }
    #debug { padding: 20px; font-family: monospace; }
  </style>
</head>
<body>
  <div id="debug">Loading...</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const debug = document.getElementById('debug');

    // User's test coordinates
    const startLat = 34.62649;
    const startLon = -84.19385;
    const endLat = 34.66603;
    const endLon = -84.13631;

    debug.innerHTML = 'Loading GPX...';

    // Load GPX and render map
    fetch('/data/appalachian_trail.gpx')
      .then(res => res.text())
      .then(gpxText => {
        debug.innerHTML += '<br>GPX loaded, parsing...';

        const parser = new DOMParser();
        const gpx = parser.parseFromString(gpxText, 'text/xml');
        const trackPoints = gpx.getElementsByTagName('trkpt');

        const trailPath = [];
        for (let i = 0; i < trackPoints.length; i++) {
          const lat = parseFloat(trackPoints[i].getAttribute('lat') || '0');
          const lon = parseFloat(trackPoints[i].getAttribute('lon') || '0');
          if (lat && lon) {
            trailPath.push([lat, lon]);
          }
        }

        debug.innerHTML += '<br>Parsed ' + trailPath.length + ' points';

        // Find closest points
        let startIdx = 0;
        let endIdx = trailPath.length - 1;
        let minStartDist = Infinity;
        let minEndDist = Infinity;

        trailPath.forEach((point, idx) => {
          const distToStart = Math.sqrt(
            Math.pow(point[0] - startLat, 2) + Math.pow(point[1] - startLon, 2)
          );
          const distToEnd = Math.sqrt(
            Math.pow(point[0] - endLat, 2) + Math.pow(point[1] - endLon, 2)
          );

          if (distToStart < minStartDist) {
            minStartDist = distToStart;
            startIdx = idx;
          }
          if (distToEnd < minEndDist) {
            minEndDist = distToEnd;
            endIdx = idx;
          }
        });

        const segment = trailPath.slice(startIdx, endIdx + 1);
        debug.innerHTML += '<br>Route segment: ' + segment.length + ' points';
        debug.innerHTML += '<br>Start idx: ' + startIdx + ' at ' + JSON.stringify(trailPath[startIdx]);
        debug.innerHTML += '<br>End idx: ' + endIdx + ' at ' + JSON.stringify(trailPath[endIdx]);

        const midIdx = Math.floor(segment.length / 2);
        const center = segment[midIdx];

        debug.innerHTML += '<br>Map center: ' + JSON.stringify(center);
        debug.innerHTML += '<br>Rendering map...';

        // Create map
        const map = L.map('map').setView(center, 11);

        L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenTopoMap contributors'
        }).addTo(map);

        // Add polyline
        L.polyline(segment, {
          color: '#4a7c59',
          weight: 4,
          opacity: 0.8
        }).addTo(map);

        // Add markers
        L.marker([startLat, startLon])
          .addTo(map)
          .bindPopup('Start Point');

        L.marker([endLat, endLon])
          .addTo(map)
          .bindPopup('End Point');

        debug.innerHTML += '<br><strong>Map rendered successfully!</strong>';
      })
      .catch(err => {
        debug.innerHTML += '<br><strong style="color:red">Error: ' + err.message + '</strong>';
        console.error(err);
      });
  </script>
</body>
</html>
